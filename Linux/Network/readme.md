# Vagrant-стенд c сетевой лабораторией

## Описание задачи

Задание состоит из 2-х частей: теоретической и практической.
В теоретической части требуется: 
- Найти свободные подсети
- Посчитать количество узлов в каждой подсети, включая свободные
- Указать Broadcast-адрес для каждой подсети
- Проверить, нет ли ошибок при разбиении

В практической части требуется: 
- Соединить офисы в сеть согласно логической схеме и настроить роутинг
- Интернет-трафик со всех серверов должен ходить через inetRouter
- Все сервера должны видеть друг друга (должен проходить ping)
- У всех новых серверов отключить дефолт на NAT (eth0), который vagrant поднимает для связи
- Добавить дополнительные сетевые интерфейсы, если потребуется


## Выполнение

На схеме реализованная сеть:

![Image alt](https://github.com/Sof-Lab/Home_Lab/blob/main/Linux/Network/%D0%A1%D1%85%D0%B5%D0%BC%D0%B0%20%D1%81%D0%B5%D1%82%D0%B8.png)

### 1. Теоретическая часть.

Рассчитанные таблицы топологии по схеме:

*Central Router network*
| Name | Network | Netmask | N | Hostmin | Hostmax | Broadcast |
|---|---|---|---|---|---|---|
| Inet | 192.168.255.0/30 | 255.255.255.252 | 2 | 192.168.255.1 | 192.168.255.2 | 192.168.255.3 |
| Inet | 192.168.255.4/30 | 255.255.255.252 | 2 | 192.168.255.5 | 192.168.255.6 | 192.168.255.7 |
| Inet | 192.168.255.8/30 | 255.255.255.252 | 2 | 192.168.255.9 | 192.168.255.10 | 192.168.255.11 |

*Central network*
| Name | Network | Netmask | N | Hostmin | Hostmax | Broadcast |
|---|---|---|---|---|---|---|
| Directors | 192.168.0.0/28 | 255.255.255.240 | 14 | 162.168.0.1 | 192.168.0.14 | 192.168.0.15 |

*Office1 network*
| Name | Network | Netmask | N | Hostmin | Hostmax | Broadcast |
|---|---|---|---|---|---|---|
| Managers | 192.168.2.128/26 | 255.255.255.192 | 62 | 192.168.2.129 | 192.168.2.190 | 192.168.2.191 |

*Office2 network*
| Name | Network | Netmask | N | Hostmin | Hostmax | Broadcast |
|---|---|---|---|---|---|---|
| Dev | 192.168.3.0/25 | 255.255.255.128 | 126 | 192.168.3.1 | 192.168.3.126 | 192.168.3.127 |


Свободные сети:

| Network | N |
|---|---|
| 192.168.255.12/30 | 2 |
| 192.168.255.16/28 | 14 |
| 192.168.255.32/27 | 30 |
| 192.168.255.64/26 | 62 |
| 192.168.255.128/25 | 126 |
| 192.168.0.16/28 | 14 |
| 192.168.0.32/27 | 30 |
| 192.168.0.64/26 | 62 |
| 192.168.0.128/25 | 126 |
| 192.168.2.0/25 | 126 |
| 192.168.2.192/25 | 126 |
| 192.168.3.128/25 | 126 |


### 2. Практическая часть.

С помощью Vagrantfile запущено 7 вм.

На InetRouter выполнены настройки:

```console
systemctl stop ufw
systemctl disable ufw
```

Файл /etc/iptables_rules.ipv4:
```
# Generated by iptables-save v1.8.7 on Sat Oct 14 16:14:36 2023
*filter
:INPUT ACCEPT [90:8713]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [54:7429]
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
COMMIT
# Completed on Sat Oct 14 16:14:36 2023
# Generated by iptables-save v1.8.7 on Sat Oct 14 16:14:36 2023
*nat
:PREROUTING ACCEPT [1:44]
:INPUT ACCEPT [1:44]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT
# Completed on Sat Oct 14 16:14:36 2023
```

Файл со скриптом автоматического восстановления правил при перезапуске системы /etc/network/if-pre-up.d/iptables:
```
#!/bin/sh
/sbin/iptables-restore < /etc/iptables_rules.ipv4
```

Права на выполнение:
```
sudo chmod +x /etc/network/if-pre-up.d/iptables
```

На всех роутерах выполнено:
```
echo "net.ipv4.conf.all.forwarding = 1" >> /etc/sysctl.conf
sysctl -p
```

На всех вм, кроме InetRouter отключен маршрут по умолчанию в /etc/netplan/00-installer-config.yaml:
```
# This is the network config written by 'subiquity'
network:
  ethernets:
    eth0:
      dhcp4: true
      dhcp4-overrides:
          use-routes: false
      dhcp6: false
  version: 2
```

На хостах настроена маршрутизация в файле /etc/netplan/50-vagrant.yaml:

```
inetRouter:~# cat /etc/netplan/50-vagrant.yaml
---
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses:
      - 192.168.255.1/30
      routes:
      - to: 192.168.0.0/24
        via: 192.168.255.2
      - to: 192.168.2.0/24
        via: 192.168.255.2
      - to: 192.168.3.0/24
        via: 192.168.255.2
      - to: 192.168.255.0/24
        via: 192.168.255.2
```
```
centralRouter:~$ cat /etc/netplan/50-vagrant.yaml
---
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses:
      - 192.168.255.2/30
      routes:
      - to: 0.0.0.0/0
        via: 192.168.255.1
    eth2:
      addresses:
      - 192.168.0.1/28
    eth3:
      addresses:
      - 192.168.0.33/28
    eth4:
      addresses:
      - 192.168.0.65/26
    eth5:
      addresses:
      - 192.168.255.9/30
      routes:
      - to: 192.168.2.0/24
        via: 192.168.255.10
    eth6:
      addresses:
      - 192.168.255.5/30
      routes:
      - to: 192.168.3.0/24
        via: 192.168.255.6
```
```
office1Router:~$ cat /etc/netplan/50-vagrant.yaml
---
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses:
      - 192.168.255.10/30
      routes:
      - to: 0.0.0.0/0
        via: 192.168.255.9
    eth2:
      addresses:
      - 192.168.2.1/26
    eth3:
      addresses:
      - 192.168.2.65/26
    eth4:
      addresses:
      - 192.168.2.129/26
    eth5:
      addresses:
      - 192.168.2.193/26
```
```
office2Router:~$ cat /etc/netplan/50-vagrant.yaml
---
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses:
      - 192.168.255.6/30
      routes:
      - to: 0.0.0.0/0
        via: 192.168.255.5
    eth2:
      addresses:
      - 192.168.3.1/25
    eth3:
      addresses:
      - 192.168.3.129/26
    eth4:
      addresses:
      - 192.168.3.193/26
```
```
centralServer:~$ cat /etc/netplan/50-vagrant.yaml
---
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses:
      - 192.168.0.2/28
      routes:
      - to: 0.0.0.0/0
        via: 192.168.0.1
```
```
office1Server:~$ cat /etc/netplan/50-vagrant.yaml
---
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses:
      - 192.168.2.130/26
      routes:
      - to: 0.0.0.0/0
        via: 192.168.2.129
```
```
office2Server:~$ cat /etc/netplan/50-vagrant.yaml
---
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses:
      - 192.168.3.2/25
      routes:
      - to: 0.0.0.0/0
        via: 192.168.3.1
```

Командой `netplan try` применяются настрйоки маршрутизации.

После перезагрузки сеть работает корректно.
Например:
```
office1Server:~# traceroute 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  192.168.2.129 (192.168.2.129)  0.515 ms  0.306 ms  0.444 ms
 2  192.168.255.9 (192.168.255.9)  3.725 ms  3.265 ms  4.431 ms
 3  192.168.255.1 (192.168.255.1)  4.451 ms  4.562 ms  5.774 ms
 4  10.0.2.2 (10.0.2.2)  7.715 ms  7.524 ms  7.561 ms
 ***
```
```
office2Server:~$ traceroute 192.168.0.2
traceroute to 192.168.0.2 (192.168.0.2), 30 hops max, 60 byte packets
 1  192.168.3.1 (192.168.3.1)  0.466 ms  0.556 ms  0.568 ms
 2  192.168.255.5 (192.168.255.5)  0.783 ms  1.361 ms  0.955 ms
 3  192.168.0.2 (192.168.0.2)  1.405 ms  2.400 ms  2.198 ms
```