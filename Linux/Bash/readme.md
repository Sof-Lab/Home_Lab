# Vagrant-Ansible стeнд для работы с bash

## Описание задачи

Написать скрипт для CRON, который раз в час будет формировать письмо и отправлять на заданную почту.

Необходимая информация в письме:

- Список IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
- Список запрашиваемых URL (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
- Ошибки веб-сервера/приложения c момента последнего запуска;
- Список всех кодов HTTP ответа с указанием их кол-ва с момента последнего запуска скрипта.

Скрипт должен предотвращать одновременный запуск нескольких копий, до его завершения.
В письме должен быть прописан обрабатываемый временной диапазон.

## Выполнение

*Лабораторный стенд развёрнут на хосте с Windows + WSL2. На Windows установлены Vagrant и VirtualBox. Ansible установлен на WSL.*

*Все файлы для vagrant располагаются в директории windows (win_directory), у меня это - D:\VBox_Projects\bash\. Команды для работы с vagrant запускаются из той же директории.*

*Все файлы для ansible располагаются в директории wsl (wsl_directory), у меня это - /home/sof/sof/otus_labs/bash/. Команды для работы с ansible звпускаются из той же директории.*

### 1. Запуск ВМ с помощью vagrant.

Для доступа к ВМ из wsl в Vagrantfile прописан дополнительный проброс порта `ssh-for-wsl`.
В нём нужно указать ip-адрес хоста и желаемый порт ssh для подключения:
```
host: 2226, # Порт для подключения по ssh
host_ip: "192.168.1.8", # Ip-адрес Windows-хоста
```

### 2. Настройка ВМ с помощью ansible.

В файле staging/hosts.yaml нужно заполнить переменные для выполнения настройки ВМ:
```
all:
  vars: 
    vm_name: bash        		   # имя ВМ в VB
    host_ip: 192.168.1.8   		 # Ip-адрес Windows-хоста
    vm_port: 2226         		  # Порт для подключения по ssh
    dir_vagrant: /mnt/d/VBox_Projects/bash/     # Директория wsl, где расположены файлы windows-хоста для работы с vagrant
    dir_wsl: /home/sof/otus_labs/bash/       # Директория wsl, где расположены файлы ansible
    email_address: example@mail.ru      # Адрес электронной почты для отправки писем с ВМ
```

В файле staging/hosts.yaml прописан localhost для выполнения команд в wsl.
Это требуется, чтобы скопировать ключ private_key для подключения к ВМ из директории windows в директорию wsl.

Запуск Playbook bash.yml.

```console
~/otus_labs/bash$ ansible-playbook bash.yml

PLAY [WSL localhost copy private_key] **************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************
ok: [wsl]

TASK [Create directory for private_key] ************************************************************************************
changed: [wsl]

TASK [Copy private_key file] ***********************************************************************************************
changed: [wsl]

TASK [Change permissions for private_key] **********************************************************************************
changed: [wsl]

PLAY [Configure vbox_vm] ***************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************
ok: [lab_vm]

TASK [Update GPG] **********************************************************************************************************
changed: [lab_vm]

TASK [install packages] ****************************************************************************************************
changed: [lab_vm]

TASK [update] **************************************************************************************************************
changed: [lab_vm]

TASK [remove the ipv6 line from /etc/hosts] ********************************************************************************
changed: [lab_vm]

TASK [Start postfix] *******************************************************************************************************
changed: [lab_vm]

TASK [Set timezone] ********************************************************************************************************
changed: [lab_vm]

TASK [Create directory for script] *****************************************************************************************
changed: [lab_vm]

TASK [Insert script] *******************************************************************************************************
changed: [lab_vm]

TASK [Change permissions for script] ***************************************************************************************
changed: [lab_vm]

TASK [Insert log file] *****************************************************************************************************
changed: [lab_vm]

TASK [Creates a cron file under script] ************************************************************************************
changed: [lab_vm]

PLAY RECAP *****************************************************************************************************************
lab_vm                     : ok=12   changed=11   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
wsl                        : ok=4    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

### 2. Проверка результатов.

На почту пришло письмо с содержанием:

![Image alt](https://github.com/Sof-Lab/Home_Lab/blob/main/Linux/Bash/results/first-mail.png)

Все требования учтены.
Через час скрипт запустился снова и пришло следующее письмо:

![Image alt](https://github.com/Sof-Lab/Home_Lab/blob/main/Linux/Bash/results/second-mail.png)

Так как лог-файл не заполняется новыми данными, в письме указано, что обрабатывать нечего и временной промежуток.